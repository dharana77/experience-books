

### 

### Q. 단일 요청 처리를 위해 여러 마이크로서비스들이 로그를 남길 때 시간 순서의 문제가 발생할 수 있을텐데, 예를 들어, A 마이크로서비스에서 먼저 처리하고 그 후 B 라는 마이크로서비스가 처리한다면 로그 시간 순서 상 B가 먼저 처리하고 A가 처리한 것처럼 보이는 문제가 생길 수 있을 것 같은데 해결할 수 있는 방법이 어떤 것이 있을까?


- 이를 방지하기 위해 대표적으로 다음과 같은 방법이 있음.

- 로그 수집 시스템에서 trace ID와 span ID로 로그를 정렬: 로그를 시간 기반이 아니라 trace ID와 span ID를 기준으로 정렬하면, 실제 호출 순서에 맞게 로그가 정렬
- 모든 마이크로서비스의 시간 동기화: NTP(Network Time Protocol)를 사용하여 시스템 시간을 최대한 동기화하면 시간 차이로 인한 문제를 최소화할 수 있습니다.
  - 예를 들어, Sumo Logic과 Splunk 같은 로그 수집 및 분석 도구에서 마이크로서비스 환경에서 발생할 수 있는 로그 역전 현상을 방지하려면, 주로 trace ID, span ID와 같은 트레이싱 메타데이터를 활용한 정렬 및 필터링이 필요. 
  - 시스템 시간의 작은 차이가 있을 수 있기 때문에, 단순 시간 순 정렬로는 호출 순서를 보장하기 어려움. 다음과 같은 방법을 적용할 수 있음.



1. Trace ID 및 Span ID 기반 정렬
- Sumo Logic과 Splunk 모두 로그 데이터를 다양한 필드로 정렬할 수 있습니다. 이를 통해, 각 호출의 trace ID와 span ID를 활용하여 시간 순서와 무관하게 호출 흐름에 맞게 로그를 정렬할 수 있습니다.

- Sumo Logic에서 traceId 필드로 로그를 그룹화하고, 각 마이크로서비스에서 생성된 spanId를 사용해 내부적으로 호출 흐름을 추적할 수 있습니다.
- Splunk에서는 transaction 명령어를 사용하여 동일한 trace ID 내에서 span ID에 따라 이벤트를 그룹화하고 정렬할 수 있습니다.


2. NTP로 시간 동기화

- 모든 마이크로서비스 서버의 시간을 가능한 한 정확하게 동기화하면, 시간 차이에 의한 로그 역전 현상을 최소화할 수 있습니다. NTP(Network Time Protocol)을 사용해 각 마이크로서비스 서버의 시간을 조정하면 좋습니다. 이는 시스템 시간 기반으로 로그가 잘못 정렬될 가능성을 줄여줍니다. 
- 일반적인 로그 플랫폼은 system timestamp과 receipt time 을 활용해 로그를 정렬할 수 있습니다.


3. 로그 수집 시스템에서 로그 처리 지연 방지
- 로그 수집 시스템에서 각 마이크로서비스의 로그가 네트워크 지연으로 인해 순서가 뒤바뀌지 않도록, 로그 버퍼링 및 큐 시스템을 최적화할 필요가 있음.
- 네트워크 지연이나 처리 속도 차이로 인해 로그가 시간 순서대로 수집되지 않는 상황을 방지하려면 로그 수집 과정에서 잠재적인 지연 요소를 최소화해야 함


4. 로그 필터링 및 라벨링
- 각 마이크로서비스에서 발생하는 로그에 추가적인 메타데이터(예: 호출 순서나 서비스 간 호출 관계에 대한 태그)를 부여해, 로그 상에서 A->B->C 순서를 명확하게 식별할 수 있도록 함. 
- Sumo Logic과 Splunk에서 이 메타데이터를 기준으로 로그를 필터링하면 역전 현상을 방지할 수 있습니다.
- 이러한 방법을 통해, 시스템 시간의 작은 차이가 있더라도 호출 순서가 정확하게 기록되도록 할 수 있습니다.



#### 추가
- NTP 란 무엇인가
- trace ID와 span ID란 무엇인가
  - trace ID
    - 분산 시스템에서 요청이나 트랜젝션을 추가하기 위해 사용하는 고유한 식별자
    - 서비스와 마이크로 서비스가 함께 작동하는 환경에서 특정 요청의 흐름을 추적할 수 있도록 도움
    - 일반적으로 모든 동일한 관련 로그나 이벤트에 동일 trace id가 포함되어 있어 문제를 디버깅하거나 성능을 모니터링할 때 유용
  - span Id
    - trace id의 일부로 특정 작업이나 처리 단위를 나타는 고유 식별자
    - 하나의 요청이 여러 서비스에서 처리되는 동안 각 서비스의 작업은 span으로 표현됨
    - 각 span은 부모 span과의 관계를 가질 수 있어 전체 요청의 흐름을 계층적으로 이해하는데 도움이 됨
    - span id는 보통 trace id와 함께 사용되어 요청의 세부적인 단계를 추적함

- system timestam 이란
  - 시스템에서 현재 시간을 기록하는 값
- receipt time 이란
  - 특정 이벤트나 거래가 발생한 후 그에 대한 확인이나 응답이 이루어진 시간
