
## 신뢰할수 있고 확장 가능하며 유지보수하기 쉬운 애플리케이션

많은 어플리케이션은 계산 중심적이기보다 데이터 중심적이다.

### 데이터 시스템에 관한 생각
데이터베이스, 캐시, 검색 색인, 스트림 처리, 일괄 처리 등이 필요하며
성공적으로 데이터 시스템을 추상화해 사용하고 있다.

이것들의 구현 방식은 다 다를 수 있는데 왜 데이터 시스템이라는 포괄적 용어로 묶어야 할까?
분류와 경계가 흐려지고 있는 측면이 있으며 단일 도구로는 더 이상 처리와 저장 모두를 만족시킬 수 없을 정도의 과도하고 광범위한 요구사항을 갖고 있기 때문이기도 하다.

대신 작업은 단일 도구에서 효율적으로 처리할 수 있는 태스크(task)로 나누고 다양한 도구들은 애플리케이션 코드를 활용해 서로 연결한다.


이에 따라 개발자는 애플리케이션 개발자 뿐만 아니라 데이터 시스템 설계자이기도 하다.


신뢰성, 확장성, 유지보수성이라는 큰 세단계를 고려해야하며 이를 쉽게 만들어주는 간단한 해결책은 없다.

하지만 여러 애플리케이션에서 계속 반복되는 특정 패턴과 기술이 있으며, 이후 몇개의 장에서 데이터 시스템 몇가지를 예제로 살펴보고 
이런 목표를 향해 데이터 시스템이 어떻게 작동하는지 분석할 것이다.


확장성의 측면에서 부하 성능을 테스트할때

트위터를 예시로 들어보자.

트위터에서는 트윗을 작성하는 기능과

홈 타임라인을 볼 수 있는 대표적인 기능이 존재한다.

단순히 초당 1,2000건 의 쓰기 처리는 상당히 쉬우나 트위터의 확장성 문제는 주로 트윗의 양이 아닌 팬 아웃에 있다.

팬아웃이란 다른 게이트의 출력에 배속된 논리 게이트 입력의 수를 의미하는 것으로 트랜젝션 처리 시스템에서 하나의 수신 요청을 처리하는데 필요한 다른 서비스의 요청 수를 설명하기 위해 사용한다.

즉 트위터에서 개별 사용자는 많은 사용자들을 팔로우하고 많은 사람이 개별 사용자를 팔로우하는 곳에서 문제가 발생한다.

위의 두가지 동작을 구현하는 방식은 크게 두가지가 있다.

첫째로, 트윗 작성은 간단히 새로운 트윗을 트윗 전역 컬렉션에 삽입한다. 사용자가 만일 자신의 홈 타임라인을 요청하면 팔로우하는 모든 사람을 찾고, 이 사람들의 모든 트윗을 찾아 정렬해서 합친다.


이의 쿼리(질의)는 다음과 같을 수 있다.
SELECT tweet.*, users.* FROM tweets
  JOIN users ON tweets.sender_id = users.id
  JOIN follows ON follows.followee_id = users.id
 WHERE follows.follower_id = current_user


 하지만 위의 방식을 시스템이 홈 타임라인 질의 부하를 버텨내기 위해 힘든 점이 있다. (특히 데이터가 증가할 수록)
 따라서 평균적으로 트윗 게시 요청량이 홈 타임 라인 읽기 요청량에 비해 수백배 적기 때문에 아래와 같은 방식이 훨씬 잘 동작하고 이 경우 쓰기 시점에 더 많은 일을 하고 읽기 시점에 적은 일을 하는 것이
 더 바람직하기 때문에 구현된 것이다.

 두번째 방식은
 각 수신 사용자용 트윗 우편함처럼 개별 사용자의 홈 타임라인 캐시를 유지하는 것이다. 사용자가 트윗을 작성하면 해당 사용자를 팔로우하는 사람들을 모두 찾고 팔로워 각자의 홈 타임라인 캐시에 새로운 트윗을
 삽입한다. 그러면 홈 타임라인의 읽기 요청은 요청 결과를 미리 계산했기 때문에 비용이 저렴하다.


 그러나 접근 방식 2의 불리한 점은 이제는 트윗 작성이 많은 부가 작업을 필요로 한 다는 점이다.
 평균적으로 트윗이 약 70여명의 팔로워에게 전달되므로 초당 4.6k의 트윗은 홈 타임 라인 캐시에 초당 345k 건의 쓰기가 된다.

 그러나 평균 값은 사용자마다 팔로워 수가 매우 다르다는 점을 가린다.

 즉 일부 사용자는 팔로워가 3천만 명이 넘기 때문에 이것은 단일 트윗이 홈 타임라인에 3천만 건 이상의 쓰기 요청이 될지도 모른다는 의미다. (!)

 적시에 트윗을 전송하는 작업이 (트위터는 5초 이내에 팔로워에게 트윗을 전송하려고 노력한다.) 중요한 과제이다.

 위와 같은 트위터 사례에서 사용자당 팔로워의 분포(해당 사용자의 트윗 빈도에 따라 편중될 수도 있음)는 팬 아웃 부하를 결정하기 때문에 확장성을 논의할때 핵심 부하 매개변수가 된다.

 애플리케이션 마다 특성은 매우 다르지만 부하에 대한 추론에 비슷한 원리를 적용할 수 있다.


 이 내용의 최종 결과는 다음과 같다.

 접근 방식 2가 견고하게 구현되어 트위터는 두 접근 방식의 하이브리드로 바꾸고 있다.
 대부분 사용자의 트윗은 사람들이 작성할 때 홈 타임라인에 펼쳐지지만 팔로워 수가 매우 많은 소수 사용자(인플루언서 등)은 팬 아웃에서 제외된다.
 사용자가 팔로우 한 유명인의 트윗은 별도로 가져와 접근 방식 1처럼 읽는 시점에 사용자의 홈 타임 라인에 합친다.
 이 혼합형 접근 방식은 좋은 성능으로 지속적인 전송이 가능하다.
 조금 더 기술적인 근거를 다룬 후에 12장에서 트위터 사례를 다시 설명한다.

 

 
### 
